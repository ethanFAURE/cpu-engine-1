#include "stdafx.h"

Thread::Thread()
{
	m_callback = nullptr;
	m_hThread = nullptr;
	m_idThread = 0;
	m_idThreadParent = 0;
}

Thread::~Thread()
{
	assert( IsRunning()==false );

	if ( m_idThread && m_hThread )
		TerminateThread(m_hThread, 0);

	if ( m_hThread )
		CloseHandle(m_hThread);
}

////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

bool Thread::Run()
{
	assert( IsRunning()==false );

	DWORD idThread;
	HANDLE hThread = CreateThread(nullptr, 0, ThreadProc, (void*)this, CREATE_SUSPENDED, &idThread);
	if ( hThread==nullptr )
		return false;

	m_idThreadParent = GetCurrentThreadId();
	m_hThread = hThread;
	m_idThread = idThread;
	ResumeThread(m_hThread);
	return true;
}

bool Thread::Run(const _METHOD& callback)
{
	m_callback = callback;
	return Run();
}

void Thread::Wait()
{
	if ( m_hThread )
	{
		WaitForSingleObject(m_hThread, INFINITE);
		CloseHandle(m_hThread);
		m_hThread = nullptr;
		m_idThread = 0;
		m_idThreadParent = 0;
	}
}

////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

DWORD WINAPI Thread::ThreadProc(void* pParam)
{
	Thread* pThread = (Thread*)pParam;

	if ( pThread->m_callback!=nullptr )
		pThread->m_callback();
	else
		pThread->OnCallback();

	pThread->m_idThread = 0;
	return 0;
}
